# Лабораторная работа №3: Оркестрация ETL-процессов с Apache Airflow

## Бизнес-задача: Анализ посещаемости специалистов

### Описание проблемы
Медицинское учреждение стремится улучшить качество обслуживания пациентов и оптимизировать распределение нагрузки между врачами. Для этого необходимо понимать, к каким специалистам чаще всего обращаются пациенты разных возрастных групп. 


### Бизнес-ценность решения
-  **Персонализированный подход** — понимание потребностей разных возрастных групп
-  **Оптимизация ресурсов** — выявление перегруженных и недоиспользуемых специальностей
-  **Принятие решений на основе данных** - улучшение профилактической работы с разными возрастными категориями
- ⏰ **Экономия времени** - автоматическая обработка данных из разных источников
-  **Своевременное уведомление** - автоматическая отправка отчетов заинтересованным лицам

## Вариант задания №13: Медицинская аналитика — Посещаемость врачей

### Исходные данные:

| Формат | Имя файла | Поля |
|--------|-----------|------|
| **CSV** | `patients.csv` | `patient_id`, `age_group` |
| **Excel** | `visits.xlsx` | `patient_id`, `doctor_specialty` |
| **JSON** | `diagnoses.json` | `patient_id`, `diagnosis` |

**Бизнес-логика расчета:**
```
 Расчет посещаемости врачей**:
 visit_count = Количество визитов к врачу в группе
 total_visits = Общее число визитов в группе
 percentage = (visit_count / total_visits) × 100%

```

**Ожидаемый результат:** Аналитический отчет по посещаемости врачей по возрастным группам с рекомендациями для медицинского учреждения.

## Архитектура решения

### Общая схема системы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           DOCKER COMPOSE ENVIRONMENT                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │   PostgreSQL    │    │   Apache        │    │    MailHog      │         │
│  │   Database      │    │   Airflow       │    │  Email Service  │         │
│  │                 │    │                 │    │                 │         │
│  │ Port: 5432      │    │ ┌─────────────┐ │    │ SMTP: 1025      │         │
│  │ User: airflow   │◄───┤ │ Webserver   │ │    │ Web: 8025       │         │
│  │ DB: airflow     │    │ │ Port: 8080  │ │    │                 │         │
│  │                 │    │ └─────────────┘ │    │                 │         │
│  └─────────────────┘    │ ┌─────────────┐ │    └─────────────────┘         │
│                         │ │ Scheduler   │ │                                │
│                         │ │             │ │                                │
│                         │ └─────────────┘ │                                │
│                         └─────────────────┘                                │
│                                   │                                        │
│                         ┌─────────▼─────────┐                              │
│                         │   DAGs Volume     │                              │
│                         │   ./dags:/opt/    │                              │
│                         │   airflow/dags    │                              │
│                         └───────────────────┘                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              HOST SYSTEM                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │   Data Files    │    │   DAG Files     │    │  Result Files   │         │
│  │                 │    │                 │    │                 │         │
│  │ apps.csv        │    │ mobile_apps_    │    │ *.db (SQLite)   │         │
│  │ installs.xlsx   │    │ retention_dag.py│    │ *.txt (Reports) │         │
│  │ uninstalls.json │    │                 │    │ *.csv (Data)    │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Web Interfaces                              │   │
│  │                                                                     │   │
│  │  http://localhost:8080  - Apache Airflow UI                        │   │
│  │  http://localhost:8025  - MailHog Web Interface                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### ETL-процесс для анализа удержания пользователей

```
                    EXTRACT PHASE (Параллельно)
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ extract_patients│  │  extract_visits │  │extract_diagnoses│
│                 │  │                 │  │                 │
│  patients.csv   │  │   visits.xlsx   │  │  diagnoses.json │
│ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │
│ │patient_id   │ │  │ │patient_id   │ │  │ │patient_id   │ │
│ │age_group    │ │  │ │doctor_      │ │  │ │diagnosis    │ │
│ │             │ │  │ │specialty    │ │  │ │             │ │
│ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │
└─────────────────┘  └─────────────────┘  └─────────────────┘
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               │
                    TRANSFORM PHASE
                ┌────────────────────────────┐
                │ transform_data             │
                │                            │
                │ 1. JOIN данные             │
                │ 2. GROUP BY                │
                │    category                │
                │3. COUNT визитов            │
                │4. Определение топ-врача    │
                │    в каждой группе         │
                │ 5. Дополнительные метрики: │
                │    - visit_count           │
                │    - total_visits          │
                │    - percentage            | 
                └────────|───────────────────┘
                         │
                    LOAD PHASE
                ┌─────────────────┐
                │load_to_database │
                │                 │
                │ SQLite DB       │
                │ - total_visits  │
                │ - percentage    │
                └─────────────────┘
                         │
                 REPORTING PHASE
                ┌─────────────────┐
                │generate_report  │
                │                 │
                │ TXT Report      │
                │ CSV Data Export │
                └─────────────────┘
                         │
               NOTIFICATION PHASE
                ┌─────────────────┐
                │send_email_      │
                │notification     │
                │                 │
                │ HTML Email +    │
                │ File Attachments│
                └─────────────────┘
```

## Технический стек

| Компонент | Технология | Назначение |
|-----------|------------|------------|
| **Оркестрация** | Apache Airflow 2.5.0 | Управление ETL-процессами |
| **Контейнеризация** | Docker + Docker Compose | Изоляция и развертывание |
| **База данных (Airflow)** | PostgreSQL 12 | Метаданные Airflow |
| **База данных (Результаты)** | SQLite | Хранение результатов анализа |
| **Обработка данных** | Python 3.8 + Pandas | ETL-логика и трансформации |
| **Работа с Excel** | openpyxl | Чтение Excel файлов |
| **Email-тестирование** | MailHog | Тестирование email-уведомлений |
| **Веб-интерфейс** | Airflow WebUI | Мониторинг и управление |

## Пошаговая инструкция запуска

### Шаг 1: Подготовка окружения

1. **Клонирование проекта**:
   ```bash
   git clone https://github.com/GoshaMareev/DataCollectionAndAnalytics.git
   cd DataCollectionAndAnalytics/Lab_3
   ```

2. **Запуск всех сервисов**:
   ```bash
   sudo docker compose up -d
   ```

3. **Проверка статуса контейнеров**:
   ```bash
   sudo docker ps
   ```
   Должны быть запущены: `webserver`, `scheduler`, `postgres`, `mailhog`

### Шаг 2: Работа с Apache Airflow

#### Доступ к веб-интерфейсу
- **URL**: http://localhost:8080
- **Логин**: admin
- **Пароль**: admin

#### Что смотреть в Airflow UI:

1. **Главная страница (DAGs)**:
   - Найдите DAG `patient_visits_analysis_dag`
   - Убедитесь, что он включен (переключатель слева должен быть активен)

2. **Запуск DAG**:
   - Кликните на название DAG
   - Нажмите кнопку "Trigger DAG" (▶️) для ручного запуска
   - Или дождитесь автоматического запуска по расписанию

3. **Мониторинг выполнения**:
   - **Graph View** - визуальное представление задач и их зависимостей
   - **Tree View** - история запусков DAG
   - **Gantt View** - временная диаграмма выполнения задач

4. **Статусы задач**:
   -  **Success** - задача выполнена успешно
   -  **Failed** - задача завершилась с ошибкой
   -  **Running** - задача выполняется
   - ⚪ **Queued** - задача в очереди на выполнение

5. **Просмотр логов**:
   - Кликните на задачу в Graph View
   - Выберите "View Log" для просмотра детальных логов

### Шаг 3: Проверка email-уведомлений в MailHog

#### Доступ к MailHog
- **URL**: http://localhost:8025

#### Что смотреть в MailHog:

1. **После успешного выполнения DAG** появится письмо:
   - **От**: airflow@example.com
   - **Кому**: test@example.com
   - **Тема**: " Анализ коэффициента удержания мобильных приложений - Результаты"

2. **Содержимое письма**:
   -  HTML-таблица с результатами анализа по посещаемости врачей по возрастным группам
   -  Прикрепленные файлы:
     - `patient_visit_analysis_report.txt` - подробный отчет
     - `patient_visit_analysis_data.csv` - данные в формате CSV

3. **Интерфейс MailHog**:
   ```
   ┌─────────────────────────────────────────┐
   │  MailHog Web Interface                  │
   │  http://localhost:8025                  │
   ├─────────────────────────────────────────┤
   │   Inbox (1)                          │
   │  ┌─────────────────────────────────────┐ │
   │  │ ✉️  Анализ коэффициента удержания   │ │
   │  │     airflow@example.com             │ │
   │  │     2024-10-02 15:30:45            │ │
   │  └─────────────────────────────────────┘ │
   │                                         │
   │   Message Preview:                    │
   │  HTML-таблица с результатами           │
   │   Attachments: 2 files               │
   └─────────────────────────────────────────┘
   ```

### Шаг 4: Проверка результатов анализа

#### Использование скрипта check_results.py

1. **Установка зависимостей**:
   ```bash
   pip install -r requirements.txt
   ```

2. **Проверка результатов в базе данных**:
   ```bash
   python3 check_results.py
   ```
   Скрипт автоматически:
   - Найдет контейнер scheduler
   - Скопирует базу данных SQLite из контейнера
   - Покажет результаты анализа в удобном формате

3. **Копирование файлов результатов**:
   ```bash
   python3 check_results.py --files
   ```
   Скопирует из контейнера:
   - `patient_visit_analysis_report.txt` - подробный отчет
   - `patient_visit_analysis_data.csv` - данные для Excel

4. **Справка по скрипту**:
   ```bash
   python3 check_results.py --help
   ```

#### Вывод результатов:

```
РЕЗУЛЬТАТЫ АНАЛИЗА ПОСЕЩАЕМОСТИ ВРАЧЕЙ ПО ВОЗРАСТНЫМ ГРУППАМ:
================================================================================
age_group top_doctor_specialty  visit_count  total_visits  percentage       analysis_date
     0-18              педиатр            4             5        80.0 2025-11-07 21:10:46
    19-35             терапевт            4             5        80.0 2025-11-07 21:10:46
    36-50            кардиолог            3             5        60.0 2025-11-07 21:10:46
      51+            кардиолог            2             5        40.0 2025-11-07 21:10:46

ОБЩАЯ СТАТИСТИКА:
  Общее количество визитов: 20
  Средняя доля лидирующего специалиста: 65.00%

НАИБОЛЕЕ ЧАСТО ПОСЕЩАЕМЫЙ СПЕЦИАЛИСТ:
  'педиатр' в группе '0-18' (80.00%)

НАИМЕНЕЕ ЕДИНООБРАЗНОЕ ПОВЕДЕНИЕ:
  В группе '51+' лидер имеет лишь 40.00%
РЕКОМЕНДАЦИИ:
- В группах 0-18 и 19-35 наблюдается высокая лояльность к педиатру и терапевту — рекомендуется масштабировать успешные практики общения и обслуживания.
- Для пациентов 36+ следует внедрить модель персонального врача и регулярные профилактические осмотры.
- В группе 51+ низкая концентрация визитов на одного врача — требуется усиление профилактической работы, особенно по сердечно-сосудистым заболеваниям.
- Рекомендуется провести анализ диагнозов для понимания причин визитов и оптимизации направлений.
```

### Шаг 5: Остановка сервисов

```bash
sudo docker compose down
```

## Полная очистка проекта

### Автоматическая очистка с помощью cleanup.sh

Используйте готовый скрипт для полной очистки Docker окружения:

```bash
# Сделать скрипт исполняемым
chmod +x cleanup.sh

# Запустить полную очистку
sudo ./cleanup.sh
```

**Что делает скрипт cleanup.sh:**
- ✅ Останавливает все контейнеры
- ✅ Удаляет все контейнеры проекта
- ✅ Удаляет образы проекта (Apache Airflow, PostgreSQL, MailHog)
- ✅ Удаляет все тома и сети Docker
- ✅ Очищает систему Docker от неиспользуемых ресурсов
- ✅ Удаляет локальные файлы результатов
- ✅ Показывает подробную статистику очистки
- ✅ Запрашивает подтверждение перед выполнением

**Использование:**
```bash
sudo ./cleanup.sh
```

Скрипт интерактивный и безопасный - запросит подтверждение перед удалением данных.

## Структура проекта

```
Lab_03/
├── dags/                              # DAG-файлы Airflow
│   ├── data/                          # Исходные данные для ETL
│   │   ├── patients.csv               # Пациенты: patient_id, age_group (20 записей)
│   │   ├── visits.xlsx                # Визиты: patient_id, doctor_specialty (20 записей)
│   │   └── diagnoses.json             # Диагнозы: patient_id, diagnosis (20 записей)
│   ├── 01_umbrella.py                 # Пример DAG (оригинальный, не используется)
│   ├── aggreg.py                      # Пример агрегации (оригинальный, не используется)
│   └── patient_visits_analysis_dag.py # Основной DAG: анализ посещаемости врачей
├── docker-compose.yml                 # Конфигурация Docker Compose для Airflow
├── requirements.txt                   # Зависимости Python (pandas, openpyxl и др.)
├── check_result.py                    # Скрипт проверки результатов в БД и файлах
├── cleanup.sh                         # Скрипт полной очистки (логи, БД, файлы)
├── README.md                          # Документация проекта (описание задачи, схема, запуск)
├── patient_analysis.db                # Результат: SQLite база данных (создаётся автоматически)
├── patient_visit_analysis_data.csv    # Отчёт: данные анализа в формате CSV
└── patient_visit_analysis_report.txt  # Отчёт: текстовый отчёт с интерпретацией
```

## Результаты выполнения

После успешного выполнения DAG вы получите:

1. ** Аналитический отчет** с расчетом коэффициента удержания по категориям
2. ** Email-уведомление** с HTML-таблицей результатов и прикрепленными файлами
3. ** Файлы результатов**:
   - `retention_analysis_report.txt` - подробный текстовый отчет
   - `retention_analysis_data.csv` - данные в формате CSV для дальнейшего анализа
   - `mobile_apps_retention.db` - база данных SQLite с результатами
4. ** Бизнес-рекомендации** на основе анализа данных

## Выводы

### Технические достижения
1. ✅ **Успешно реализован полный ETL-процесс** с использованием Apache Airflow
2. ✅ **Автоматизирована обработка разнородных данных** (CSV, Excel, JSON)
3. ✅ **Настроена оркестрация задач** с правильными зависимостями и параллельным выполнением
4. ✅ **Реализованы уведомления** с отправкой результатов по email
5. ✅ **Обеспечена отказоустойчивость** с обработкой ошибок и повторными попытками

### Бизнес-результаты
1.  **Автоматизирован расчет ключевых метрик** удержания пользователей
2.  **Выявлены категории приложений** с различными показателями эффективности
3.  **Созданы рекомендации** для улучшения продуктовой стратегии
4. ⏰ **Сокращено время** на подготовку аналитических отчетов
5.  **Обеспечена своевременная доставка** результатов заинтересованным лицам

### Практические навыки
- Проектирование и реализация ETL-процессов
- Работа с Apache Airflow (DAGs, операторы, зависимости)
- Контейнеризация приложений с Docker Compose
- Обработка данных с помощью Python и Pandas
- Настройка email-уведомлений и мониторинга
- Работа с различными форматами данных (CSV, Excel, JSON, SQLite)

### Возможности для развития
- Добавление более сложных аналитических метрик
- Интеграция с реальными источниками данных (API, базы данных)
- Настройка алертов при критических изменениях показателей
- Создание дашбордов для визуализации результатов
- Масштабирование на кластер Airflow для больших объемов данных

Данная лабораторная работа демонстрирует полный цикл создания производственного ETL-решения с использованием современных инструментов оркестрации данных.
